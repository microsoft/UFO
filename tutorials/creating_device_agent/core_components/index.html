<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Core Components - UFO³ Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Core Components";
        var mkdocs_page_input_path = "tutorials/creating_device_agent/core_components.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> UFO³ Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../choose_path/">Choose Your Path</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../project_directory_structure/">Project Directory Structure</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/quick_start_galaxy/">Quick Start (UFO³ Agent Galaxy)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/quick_start_ufo2/">Quick Start (UFO²)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/quick_start_linux/">Quick Start (Linux Agent)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/quick_start_mobile/">Quick Start (Mobile Agent)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/migration_ufo2_to_galaxy/">Migration UFO² → UFO³</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/more_guidance/">More Guidance</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Configuration & Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Configuration System</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/agents_config/">Agent Configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/system_config/">System Configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/rag_config/">RAG Configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/prices_config/">Pricing Configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/third_party_config/">Third-Party Configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/mcp_reference/">MCP Reference</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/migration/">Migration Guide</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/system/extending/">Extending Configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Galaxy Configuration</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../configuration/system/galaxy_devices/">Devices</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../configuration/system/galaxy_constellation/">Constellation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../configuration/system/galaxy_agent/">Agent</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Model Setup</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/openai/">OpenAI</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/azure_openai/">Azure OpenAI</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/operator/">OpenAI CUA (Operator)</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/gemini/">Gemini</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/claude/">Claude</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/qwen/">Qwen</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/deepseek/">DeepSeek</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/ollama/">Ollama</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../configuration/models/custom_model/">Custom Model</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">UFO³ Agent Galaxy</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../galaxy/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../galaxy/webui/">WebUI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Galaxy Client</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/client/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/client/constellation_client/">ConstellationClient</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/client/device_manager/">DeviceManager</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/client/components/">Components</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/client/aip_integration/">AIP Integration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/client/galaxy_client/">GalaxyClient</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Agent Registration</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/agent_registration/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/agent_registration/agent_profile/">Agent Profile</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/agent_registration/device_registry/">Device Registry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/agent_registration/registration_flow/">Registration Flow</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Task Constellation (DAG)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation/task_star/">TaskStar</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation/task_star_line/">TaskStarLine</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation/task_constellation/">TaskConstellation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation/constellation_editor/">ConstellationEditor</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Constellation Agent</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_agent/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_agent/state/">State Machine</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_agent/strategy/">Strategy Pattern</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_agent/command/">MCP Commands</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Constellation Orchestrator</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/event_driven_coordination/">Event-Driven Coordination</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/asynchronous_scheduling/">Asynchronous Scheduling</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/safe_assignment_locking/">Safe Assignment Locking</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/consistency_guarantees/">Consistency Guarantees</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/batched_editing/">Batched Editing</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/constellation_manager/">Constellation Manager</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/constellation_orchestrator/api_reference/">API Reference</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Observer System</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/observer/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/observer/event_system/">Event System</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/observer/progress_observer/">Progress Observer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/observer/agent_output_observer/">Agent Output Observer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/observer/synchronizer/">Synchronizer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/observer/metrics_observer/">Metrics Observer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/observer/visualization_observer/">Visualization Observer</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Evaluation & Logging</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/evaluation/trajectory_report/">Trajectory Report</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/evaluation/performance_metrics/">Performance Metrics</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../galaxy/evaluation/result_json/">Result JSON Reference</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">UFO² Desktop AgentOS</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ufo2/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../ufo2/as_galaxy_device/">Using as Galaxy Device</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >HostAgent</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/host_agent/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/host_agent/state/">State Machine</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/host_agent/strategy/">Processing Strategy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/host_agent/commands/">Command System</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >AppAgent</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/app_agent/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/app_agent/state/">State Machine</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/app_agent/strategy/">Processing Strategy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/app_agent/commands/">Command System</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Core Features</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/core_features/hybrid_actions/">Hybrid GUI–API Actions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Control Detection</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/control_detection/overview/">Overview</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/control_detection/uia_detection/">UIA Detection</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/control_detection/visual_detection/">Visual Detection</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/control_detection/hybrid_detection/">Hybrid Detection</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Knowledge Substrate</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/knowledge_substrate/overview/">Overview</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/knowledge_substrate/learning_from_help_document/">Help Documents</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/knowledge_substrate/learning_from_bing_search/">Bing Search</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/knowledge_substrate/experience_learning/">Experience Learning</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/core_features/knowledge_substrate/learning_from_demonstration/">Demos</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/core_features/multi_action/">Speculative Multi-Action</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Advanced Usage</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/advanced_usage/follower_mode/">Follower Mode</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/advanced_usage/batch_mode/">Batch Mode</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/advanced_usage/operator_as_app_agent/">Operator Integration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/advanced_usage/customization/">Customization</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Prompts</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/prompts/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/prompts/basic_template/">Basic Template</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/prompts/examples_prompts/">Examples</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Evaluation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/evaluation/evaluation_agent/">EvaluationAgent</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/evaluation/benchmark/overview/">Benchmark Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/evaluation/benchmark/windows_agent_arena/">Windows Agent Arena</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/evaluation/benchmark/osworld/">OSWorld (Windows)</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Performance Logs</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/evaluation/logs/overview/">Overview</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/evaluation/logs/evaluation_logs/">Evaluation Logs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/evaluation/logs/markdown_log_viewer/">Markdown Log Viewer</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/evaluation/logs/request_logs/">Request Logs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/evaluation/logs/screenshots_logs/">Screenshots Logs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/evaluation/logs/step_logs/">Step Logs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../ufo2/evaluation/logs/ui_tree_logs/">UI Tree Logs</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Dataflow</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/dataflow/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/dataflow/instantiation/">Instantiation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/dataflow/execution/">Execution</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/dataflow/windows_app_env/">Windows App Environment</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../ufo2/dataflow/result/">Result</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Linux Agent</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/as_galaxy_device/">Using as Galaxy Device</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/state/">State Machine</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/strategy/">Processing Strategy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../linux/commands/">MCP Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mobile Agent</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mobile/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mobile/as_galaxy_device/">Using as Galaxy Device</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mobile/state/">State Machine</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mobile/strategy/">Processing Strategy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mobile/commands/">MCP Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorials & Development</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../creating_mcp_servers/">Creating Custom MCP Servers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../creating_third_party_agents/">Creating Custom Third-Party Agents</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Creating Custom Device Agents</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../client_setup/">Client Setup</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Core Components</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#table-of-contents">Table of Contents</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#component-overview">Component Overview</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#what-youll-build">What You'll Build</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-1-agent-class">Step 1: Agent Class</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#understanding-the-agent-class">Understanding the Agent Class</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#linuxagent-implementation">LinuxAgent Implementation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#creating-your-mobileagent-class">Creating Your MobileAgent Class</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#key-differences-from-linuxagent">Key Differences from LinuxAgent</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-2-processor">Step 2: Processor</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#understanding-the-processor">Understanding the Processor</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#four-processing-phases">Four Processing Phases</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#linuxagentprocessor-implementation">LinuxAgentProcessor Implementation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#creating-mobileagentprocessor">Creating MobileAgentProcessor</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#processor-configuration-guide">Processor Configuration Guide</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-3-state-manager">Step 3: State Manager</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#understanding-state-manager">Understanding State Manager</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#linuxagent-states">LinuxAgent States</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#linuxagent-state-implementation">LinuxAgent State Implementation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#creating-mobileagent-states">Creating MobileAgent States</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#state-design-guidelines">State Design Guidelines</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-4-processing-strategies">Step 4: Processing Strategies</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#understanding-strategies">Understanding Strategies</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#linuxagent-strategies">LinuxAgent Strategies</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#creating-mobileagent-strategies">Creating MobileAgent Strategies</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#strategy-design-checklist">Strategy Design Checklist</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#step-5-prompter">Step 5: Prompter</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#understanding-the-prompter">Understanding the Prompter</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#linuxagent-prompter">LinuxAgent Prompter</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#creating-mobileagent-prompter">Creating MobileAgent Prompter</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#prompter-best-practices">Prompter Best Practices</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#testing-your-implementation">Testing Your Implementation</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#unit-test-agent-class">Unit Test: Agent Class</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#integration-test-full-pipeline">Integration Test: Full Pipeline</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#related-documentation">Related Documentation</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mcp_server/">MCP Server</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../configuration/">Configuration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../testing/">Testing</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../example_mobile_agent/">Example Mobile Agent</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Enhancing AppAgent Capabilities</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../creating_app_agent/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../creating_app_agent/help_document_provision/">Help Document Provision</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../creating_app_agent/demonstration_provision/">Demonstration Provision</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../creating_app_agent/warpping_app_native_api/">Wrapping App-Native APIs</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Infrastructure</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Basic Modules</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/modules/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/modules/session/">Session</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/modules/round/">Round</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/modules/context/">Context</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/modules/dispatcher/">Dispatcher</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/modules/session_pool/">Session Factory & Pool</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/modules/platform_sessions/">Platform Sessions</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Device Agent Architecture</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/agents/overview/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/agents/agent_types/">Agent Types & Implementation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../infrastructure/agents/server_client_architecture/">Server-Client Architecture</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Architecture Layers</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../infrastructure/agents/design/state/">State Layer (Level-1)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../infrastructure/agents/design/processor/">Strategy Layer (Level-2)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../infrastructure/agents/design/strategy/">Strategy Components</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../infrastructure/agents/design/command/">Command Layer (Level-3)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Supporting Systems</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../infrastructure/agents/design/memory/">Memory System</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../infrastructure/agents/design/blackboard/">Blackboard</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../infrastructure/agents/design/prompter/">Prompter</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Agent Interaction Protocol (AIP)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../aip/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../aip/messages/">Message Reference</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../aip/protocols/">Protocol Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../aip/transport/">Transport Layer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../aip/endpoints/">Endpoints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../aip/resilience/">Resilience</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Agent Server</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/quick_start/">Quick Start</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/session_manager/">Session Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/websocket_handler/">WebSocket Handler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/client_connection_manager/">Client Connection Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/api/">HTTP API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/monitoring/">Monitoring</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Agent Client</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/quick_start/">Quick Start</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/websocket_client/">WebSocket Client</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/ufo_client/">UFO Client</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/computer_manager/">Computer Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/computer/">Computer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/device_info/">Device Info Provider</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../client/mcp_integration/">MCP Integration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">MCP (Model Context Protocol)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mcp/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mcp/data_collection/">Data Collection Servers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mcp/action/">Action Servers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mcp/configuration/">Configuration Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mcp/local_servers/">Local Servers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mcp/remote_servers/">Remote Servers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Server Reference</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/ui_collector/">UICollector</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/host_ui_executor/">HostUIExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/app_ui_executor/">AppUIExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/command_line_executor/">CommandLineExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/word_com_executor/">WordCOMExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/excel_com_executor/">ExcelCOMExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/ppt_com_executor/">PowerPointCOMExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/pdf_reader_executor/">PDFReaderExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/constellation_editor/">ConstellationEditor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/hardware_executor/">HardwareExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/bash_executor/">BashExecutor</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../mcp/servers/mobile_executor/">MobileExecutor</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/CONTRIBUTING/">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/LICENSE/">License</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/CODE_OF_CONDUCT/">Code of Conduct</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/DISCLAIMER/">Disclaimer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/SUPPORT/">Support</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../faq/">FAQ</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">UFO³ Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Tutorials & Development</li>
          <li class="breadcrumb-item">Creating Custom Device Agents</li>
      <li class="breadcrumb-item active">Core Components</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="part-1-core-components-server-side-implementation">Part 1: Core Components - Server-Side Implementation</h1>
<p>This tutorial covers the <strong>server-side components</strong> of your device agent. You'll learn to implement the Agent Class, Processor, State Manager, Strategies, and Prompter using <strong>LinuxAgent</strong> as reference.</p>
<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#component-overview">Component Overview</a></li>
<li><a href="#step-1-agent-class">Step 1: Agent Class</a></li>
<li><a href="#step-2-processor">Step 2: Processor</a></li>
<li><a href="#step-3-state-manager">Step 3: State Manager</a></li>
<li><a href="#step-4-processing-strategies">Step 4: Processing Strategies</a></li>
<li><a href="#step-5-prompter">Step 5: Prompter</a></li>
<li><a href="#testing-your-implementation">Testing Your Implementation</a></li>
</ol>
<hr />
<h2 id="component-overview">Component Overview</h2>
<h3 id="what-youll-build">What You'll Build</h3>
<div class="mermaid">graph TB
    subgraph "Server-Side Components"
        A[MobileAgent Class&lt;br/&gt;Agent Definition]
        B[MobileAgentProcessor&lt;br/&gt;Strategy Orchestration]
        C[MobileAgentStateManager&lt;br/&gt;FSM Control]
        D[Strategies&lt;br/&gt;LLM &amp; Action Logic]
        E[MobileAgentPrompter&lt;br/&gt;Prompt Construction]

        A --&gt; B
        A --&gt; C
        B --&gt; D
        A --&gt; E
    end

    style A fill:#c8e6c9
    style B fill:#fff3e0
    style C fill:#e1f5ff
    style D fill:#f3e5f5
    style E fill:#ffe1e1</div>
<p><strong>Component Responsibilities</strong>:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>File</th>
<th>Purpose</th>
<th>Example (LinuxAgent)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Agent Class</strong></td>
<td><code>customized_agent.py</code></td>
<td>Agent definition, initialization</td>
<td><code>LinuxAgent</code> class</td>
</tr>
<tr>
<td><strong>Processor</strong></td>
<td><code>customized_agent_processor.py</code></td>
<td>Strategy orchestration</td>
<td><code>LinuxAgentProcessor</code></td>
</tr>
<tr>
<td><strong>State Manager</strong></td>
<td><code>linux_agent_state.py</code></td>
<td>FSM states and transitions</td>
<td><code>LinuxAgentStateManager</code></td>
</tr>
<tr>
<td><strong>Strategies</strong></td>
<td><code>linux_agent_strategy.py</code></td>
<td>LLM and action execution logic</td>
<td><code>LinuxLLMInteractionStrategy</code></td>
</tr>
<tr>
<td><strong>Prompter</strong></td>
<td><code>linux_agent_prompter.py</code></td>
<td>Prompt construction for LLM</td>
<td><code>LinuxAgentPrompter</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="step-1-agent-class">Step 1: Agent Class</h2>
<h3 id="understanding-the-agent-class">Understanding the Agent Class</h3>
<p>The <strong>Agent Class</strong> is the entry point for your device agent. It:</p>
<ul>
<li>Inherits from <code>CustomizedAgent</code> (which extends <code>AppAgent</code>)</li>
<li>Registers with <code>AgentRegistry</code> for automatic discovery</li>
<li>Initializes prompter and default state</li>
<li>Maintains blackboard for multi-agent coordination</li>
</ul>
<h3 id="linuxagent-implementation">LinuxAgent Implementation</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/agent/customized_agent.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.app_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.basic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRegistry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.memory.blackboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">Blackboard</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.customized.customized_agent_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">LinuxAgentProcessor</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.states.linux_agent_state</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContinueLinuxAgentState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.prompter.customized.linux_agent_prompter</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinuxAgentPrompter</span>


<span class="nd">@AgentRegistry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="n">agent_name</span><span class="o">=</span><span class="s2">&quot;LinuxAgent&quot;</span><span class="p">,</span>      <span class="c1"># Unique identifier</span>
    <span class="n">third_party</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>             <span class="c1"># Mark as third-party/device agent</span>
    <span class="n">processor_cls</span><span class="o">=</span><span class="n">LinuxAgentProcessor</span>  <span class="c1"># Link to processor class</span>
<span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LinuxAgent</span><span class="p">(</span><span class="n">CustomizedAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LinuxAgent is a specialized agent that interacts with Linux systems.</span>
<span class="sd">    Executes shell commands via MCP and manages Linux device tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">main_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">example_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the LinuxAgent.</span>

<span class="sd">        :param name: The name of the agent instance</span>
<span class="sd">        :param main_prompt: Path to main prompt template YAML</span>
<span class="sd">        :param example_prompt: Path to example prompt template YAML</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call parent constructor with None for process/app (not GUI-based)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">main_prompt</span><span class="o">=</span><span class="n">main_prompt</span><span class="p">,</span>
            <span class="n">example_prompt</span><span class="o">=</span><span class="n">example_prompt</span><span class="p">,</span>
            <span class="n">process_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>      <span class="c1"># No Windows process for Linux</span>
            <span class="n">app_root_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>     <span class="c1"># No Windows app for Linux</span>
            <span class="n">is_visual</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>         <span class="c1"># Typically False for CLI-based agents</span>
        <span class="p">)</span>

        <span class="c1"># Initialize blackboard for multi-agent coordination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blackboard</span> <span class="o">=</span> <span class="n">Blackboard</span><span class="p">()</span>

        <span class="c1"># Set default state (ContinueLinuxAgentState)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_state</span><span class="p">)</span>

        <span class="c1"># Flag to track context provision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context_provision_executed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Logger for debugging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;LinuxAgent initialized with prompts: </span><span class="si">{</span><span class="n">main_prompt</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">example_prompt</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prompter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">is_visual</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">main_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">example_prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LinuxAgentPrompter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the prompter for the agent.</span>

<span class="sd">        :param is_visual: Whether the agent uses visual mode (screenshots)</span>
<span class="sd">        :param main_prompt: Path to main prompt template</span>
<span class="sd">        :param example_prompt: Path to example prompt template</span>
<span class="sd">        :return: LinuxAgentPrompter instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LinuxAgentPrompter</span><span class="p">(</span><span class="n">main_prompt</span><span class="p">,</span> <span class="n">example_prompt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContinueLinuxAgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the default state for LinuxAgent.</span>

<span class="sd">        :return: ContinueLinuxAgentState instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ContinueLinuxAgentState</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">blackboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blackboard</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the blackboard for multi-agent coordination.</span>

<span class="sd">        :return: Blackboard instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blackboard</span>
</code></pre></div>
<h3 id="creating-your-mobileagent-class">Creating Your MobileAgent Class</h3>
<p>Now let's create <code>MobileAgent</code> following the same pattern:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/agent/customized_agent.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.app_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.basic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentRegistry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.memory.blackboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">Blackboard</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.customized.customized_agent_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MobileAgentProcessor</span><span class="p">,</span>  <span class="c1"># We&#39;ll create this in Step 2</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.states.mobile_agent_state</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContinueMobileAgentState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.prompter.customized.mobile_agent_prompter</span><span class="w"> </span><span class="kn">import</span> <span class="n">MobileAgentPrompter</span>


<span class="nd">@AgentRegistry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="n">agent_name</span><span class="o">=</span><span class="s2">&quot;MobileAgent&quot;</span><span class="p">,</span>
    <span class="n">third_party</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">processor_cls</span><span class="o">=</span><span class="n">MobileAgentProcessor</span>
<span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MobileAgent</span><span class="p">(</span><span class="n">CustomizedAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MobileAgent controls Android/iOS mobile devices.</span>
<span class="sd">    Supports UI automation, app testing, and mobile-specific operations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">main_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">example_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">platform</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;android&quot;</span><span class="p">,</span>  <span class="c1"># Platform: &quot;android&quot; or &quot;ios&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the MobileAgent.</span>

<span class="sd">        :param name: Agent instance name</span>
<span class="sd">        :param main_prompt: Main prompt template path</span>
<span class="sd">        :param example_prompt: Example prompt template path</span>
<span class="sd">        :param platform: Mobile platform (&quot;android&quot; or &quot;ios&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">main_prompt</span><span class="o">=</span><span class="n">main_prompt</span><span class="p">,</span>
            <span class="n">example_prompt</span><span class="o">=</span><span class="n">example_prompt</span><span class="p">,</span>
            <span class="n">process_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">app_root_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">is_visual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Mobile agents typically use screenshots</span>
        <span class="p">)</span>

        <span class="c1"># Store platform information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_platform</span> <span class="o">=</span> <span class="n">platform</span>

        <span class="c1"># Initialize blackboard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blackboard</span> <span class="o">=</span> <span class="n">Blackboard</span><span class="p">()</span>

        <span class="c1"># Set default state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_state</span><span class="p">)</span>

        <span class="c1"># Logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;MobileAgent initialized for platform: </span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prompter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">is_visual</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">main_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">example_prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MobileAgentPrompter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the prompter for MobileAgent.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MobileAgentPrompter</span><span class="p">(</span><span class="n">main_prompt</span><span class="p">,</span> <span class="n">example_prompt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContinueMobileAgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the default state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ContinueMobileAgentState</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">blackboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Blackboard</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the blackboard.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blackboard</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">platform</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the mobile platform (android/ios).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform</span>
</code></pre></div>
<h3 id="key-differences-from-linuxagent">Key Differences from LinuxAgent</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>LinuxAgent</th>
<th>MobileAgent</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>is_visual</strong></td>
<td><code>None</code> (no screenshots)</td>
<td><code>True</code> (UI screenshots needed)</td>
</tr>
<tr>
<td><strong>Platform Tracking</strong></td>
<td>Not needed</td>
<td><code>self._platform</code> stores "android"/"ios"</td>
</tr>
<tr>
<td><strong>Processor</strong></td>
<td><code>LinuxAgentProcessor</code></td>
<td><code>MobileAgentProcessor</code></td>
</tr>
<tr>
<td><strong>Prompter</strong></td>
<td><code>LinuxAgentPrompter</code></td>
<td><code>MobileAgentPrompter</code></td>
</tr>
<tr>
<td><strong>Default State</strong></td>
<td><code>ContinueLinuxAgentState</code></td>
<td><code>ContinueMobileAgentState</code></td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Agent Class Best Practices</p>
<ul>
<li>✅ Always call <code>super().__init__()</code> first</li>
<li>✅ Initialize blackboard for multi-agent coordination</li>
<li>✅ Set <code>is_visual=True</code> if your agent uses screenshots</li>
<li>✅ Use meaningful logger messages for debugging</li>
<li>✅ Store platform-specific metadata as properties</li>
<li>✅ Keep initialization logic minimal (delegate to processor)</li>
</ul>
</div>
<hr />
<h2 id="step-2-processor">Step 2: Processor</h2>
<h3 id="understanding-the-processor">Understanding the Processor</h3>
<p>The <strong>Processor</strong> orchestrates the execution pipeline through modular strategies. It:</p>
<ul>
<li>Manages strategy execution across 4 phases</li>
<li>Configures middleware (logging, error handling, metrics)</li>
<li>Validates strategy dependencies</li>
<li>Finalizes processing context</li>
</ul>
<h3 id="four-processing-phases">Four Processing Phases</h3>
<div class="mermaid">graph LR
    A[DATA_COLLECTION&lt;br/&gt;Screenshots, UI Tree] --&gt; B[LLM_INTERACTION&lt;br/&gt;Prompt → LLM → Response]
    B --&gt; C[ACTION_EXECUTION&lt;br/&gt;Execute Commands]
    C --&gt; D[MEMORY_UPDATE&lt;br/&gt;Update Context]

    style A fill:#e3f2fd
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style D fill:#e8f5e9</div>
<h3 id="linuxagentprocessor-implementation">LinuxAgentProcessor Implementation</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/processors/customized/customized_agent_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.app_agent_processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppAgentProcessor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.context.processing_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessingPhase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.strategies.app_agent_processing_strategy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AppMemoryUpdateStrategy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.strategies.linux_agent_strategy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">LinuxActionExecutionStrategy</span><span class="p">,</span>
    <span class="n">LinuxLLMInteractionStrategy</span><span class="p">,</span>
    <span class="n">LinuxLoggingMiddleware</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinuxAgent</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LinuxAgentProcessor</span><span class="p">(</span><span class="n">CustomizedProcessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processor for Linux MCP Agent.</span>

<span class="sd">    Manages the execution pipeline with strategies for:</span>
<span class="sd">    - LLM Interaction: Generate shell commands</span>
<span class="sd">    - Action Execution: Execute commands via Linux MCP</span>
<span class="sd">    - Memory Update: Update agent memory and blackboard</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_strategies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup processing strategies for LinuxAgent.</span>

<span class="sd">        Note: No DATA_COLLECTION strategy since LinuxAgent doesn&#39;t</span>
<span class="sd">        use screenshots (relies on shell command output).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Phase 2: LLM Interaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">LLM_INTERACTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">LinuxLLMInteractionStrategy</span><span class="p">(</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># LLM failures should halt processing</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Phase 3: Action Execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">LinuxActionExecutionStrategy</span><span class="p">(</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Continue on action failures</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Phase 4: Memory Update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">MEMORY_UPDATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AppMemoryUpdateStrategy</span><span class="p">(</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Memory failures shouldn&#39;t stop agent</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup middleware pipeline for LinuxAgent.</span>

<span class="sd">        Uses custom logging middleware for Linux-specific context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middleware_chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">LinuxLoggingMiddleware</span><span class="p">()]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_processing_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">processing_context</span><span class="p">:</span> <span class="n">ProcessingContext</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize processing context by updating global context.</span>

<span class="sd">        :param processing_context: The processing context to finalize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_finalize_processing_context</span><span class="p">(</span><span class="n">processing_context</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract result from local context</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">processing_context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="c1"># Update global context with result</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ContextNames</span><span class="o">.</span><span class="n">ROUND_RESULT</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to update ContextNames from results: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
</code></pre></div>
<h3 id="creating-mobileagentprocessor">Creating MobileAgentProcessor</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/processors/customized/customized_agent_processor.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.strategies.customized_agent_processing_strategy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CustomizedScreenshotCaptureStrategy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.strategies.mobile_agent_strategy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MobileActionExecutionStrategy</span><span class="p">,</span>
    <span class="n">MobileLLMInteractionStrategy</span><span class="p">,</span>
    <span class="n">MobileLoggingMiddleware</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">MobileAgent</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MobileAgentProcessor</span><span class="p">(</span><span class="n">CustomizedProcessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processor for MobileAgent.</span>

<span class="sd">    Manages execution pipeline with mobile-specific strategies:</span>
<span class="sd">    - Data Collection: Screenshots and UI hierarchy</span>
<span class="sd">    - LLM Interaction: Mobile UI understanding</span>
<span class="sd">    - Action Execution: Touch gestures, swipes, taps</span>
<span class="sd">    - Memory Update: Context tracking</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_strategies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup processing strategies for MobileAgent.&quot;&quot;&quot;</span>

        <span class="c1"># Phase 1: Data Collection (screenshots + UI tree)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">DATA_COLLECTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">CustomizedScreenshotCaptureStrategy</span><span class="p">(</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Stop if screenshot capture fails</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Phase 2: LLM Interaction (mobile UI understanding)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">LLM_INTERACTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">MobileLLMInteractionStrategy</span><span class="p">(</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># LLM failures should halt</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Phase 3: Action Execution (touch gestures)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">MobileActionExecutionStrategy</span><span class="p">(</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Retry on action failures</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Phase 4: Memory Update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">MEMORY_UPDATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AppMemoryUpdateStrategy</span><span class="p">(</span>
                <span class="n">fail_fast</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Don&#39;t stop on memory errors</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup middleware for mobile-specific logging.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middleware_chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">MobileLoggingMiddleware</span><span class="p">()]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_processing_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">processing_context</span><span class="p">:</span> <span class="n">ProcessingContext</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize context with mobile-specific results.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_finalize_processing_context</span><span class="p">(</span><span class="n">processing_context</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract mobile-specific results</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">processing_context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">)</span>
            <span class="n">ui_state</span> <span class="o">=</span> <span class="n">processing_context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;ui_state&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ContextNames</span><span class="o">.</span><span class="n">ROUND_RESULT</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ui_state</span><span class="p">:</span>
                <span class="c1"># Store UI state for next round</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;MOBILE_UI_STATE&quot;</span><span class="p">,</span> <span class="n">ui_state</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to finalize context: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="processor-configuration-guide">Processor Configuration Guide</h3>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Required?</th>
<th>When to Use</th>
<th>Example Strategies</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DATA_COLLECTION</strong></td>
<td>Optional</td>
<td>Agent needs observations (screenshots, sensor data)</td>
<td><code>CustomizedScreenshotCaptureStrategy</code></td>
</tr>
<tr>
<td><strong>LLM_INTERACTION</strong></td>
<td><strong>Required</strong></td>
<td>All agents need LLM reasoning</td>
<td><code>LinuxLLMInteractionStrategy</code>, <code>MobileLLMInteractionStrategy</code></td>
</tr>
<tr>
<td><strong>ACTION_EXECUTION</strong></td>
<td><strong>Required</strong></td>
<td>All agents need command execution</td>
<td><code>LinuxActionExecutionStrategy</code>, <code>MobileActionExecutionStrategy</code></td>
</tr>
<tr>
<td><strong>MEMORY_UPDATE</strong></td>
<td>Recommended</td>
<td>Track agent history and context</td>
<td><code>AppMemoryUpdateStrategy</code></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Common Processor Mistakes</p>
<p>❌ <strong>Don't</strong> skip <code>_setup_strategies()</code> - processor won't execute<br />
❌ <strong>Don't</strong> use <code>fail_fast=True</code> for all strategies - agent becomes brittle<br />
❌ <strong>Don't</strong> forget to call <code>super()._finalize_processing_context()</code> - context won't propagate<br />
✅ <strong>Do</strong> use <code>fail_fast=True</code> for LLM_INTERACTION - ensures valid responses<br />
✅ <strong>Do</strong> use <code>fail_fast=False</code> for ACTION_EXECUTION - allows retry logic<br />
✅ <strong>Do</strong> add custom middleware for debugging and logging</p>
</div>
<hr />
<h2 id="step-3-state-manager">Step 3: State Manager</h2>
<h3 id="understanding-state-manager">Understanding State Manager</h3>
<p>The <strong>State Manager</strong> implements the Finite State Machine (FSM) that controls agent lifecycle. It defines:</p>
<ul>
<li><strong>States</strong>: <code>CONTINUE</code>, <code>FINISH</code>, <code>FAIL</code>, etc.</li>
<li><strong>Transitions</strong>: Rules for moving between states</li>
<li><strong>State Handlers</strong>: Logic executed in each state</li>
</ul>
<h3 id="linuxagent-states">LinuxAgent States</h3>
<div class="mermaid">stateDiagram-v2
    [*] --&gt; CONTINUE: Agent Started

    CONTINUE --&gt; CONTINUE: Processing
    CONTINUE --&gt; FINISH: Task Complete
    CONTINUE --&gt; FAIL: Error Occurred

    FAIL --&gt; FINISH: Terminal State

    FINISH --&gt; [*]

    note right of CONTINUE
        Calls agent.process(context)
        Executes processor strategies
    end note

    note right of FINISH
        Task completed successfully
        Returns control to orchestrator
    end note

    note right of FAIL
        Error occurred
        Transitions to FINISH
    end note</div>
<h3 id="linuxagent-state-implementation">LinuxAgent State Implementation</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/states/linux_agent_state.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.states.basic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentState</span><span class="p">,</span> <span class="n">AgentStateManager</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinuxAgent</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LinuxAgentStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Status enum for LinuxAgent states.&quot;&quot;&quot;</span>
    <span class="n">FINISH</span> <span class="o">=</span> <span class="s2">&quot;FINISH&quot;</span>
    <span class="n">CONTINUE</span> <span class="o">=</span> <span class="s2">&quot;CONTINUE&quot;</span>
    <span class="n">FAIL</span> <span class="o">=</span> <span class="s2">&quot;FAIL&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LinuxAgentStateManager</span><span class="p">(</span><span class="n">AgentStateManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    State manager for LinuxAgent.</span>
<span class="sd">    Manages state registration and retrieval.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_state_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">LinuxAgentState</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">none_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the none state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">NoneLinuxAgentState</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LinuxAgentState</span><span class="p">(</span><span class="n">AgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for LinuxAgent states.</span>
<span class="sd">    All LinuxAgent states inherit from this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the agent for the current step.</span>

<span class="sd">        :param agent: The LinuxAgent instance</span>
<span class="sd">        :param context: The global context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">agent_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">LinuxAgent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the agent class this state belongs to.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinuxAgent</span>
        <span class="k">return</span> <span class="n">LinuxAgent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the agent for the next step.</span>
<span class="sd">        Default: return same agent (no delegation).</span>

<span class="sd">        :param agent: Current agent</span>
<span class="sd">        :return: Next agent (typically same agent for device agents)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">agent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LinuxAgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine next state based on agent status.</span>

<span class="sd">        :param agent: Current agent</span>
<span class="sd">        :return: Next state instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">LinuxAgentStateManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the round ends.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@LinuxAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ContinueLinuxAgentState</span><span class="p">(</span><span class="n">LinuxAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CONTINUE state: Normal execution state.</span>
<span class="sd">    Calls agent.process() to execute processor strategies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle CONTINUE state by executing processor.</span>

<span class="sd">        :param agent: LinuxAgent instance</span>
<span class="sd">        :param context: Global context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtask does not end in CONTINUE state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;State name matching LinuxAgentStatus enum.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LinuxAgentStatus</span><span class="o">.</span><span class="n">CONTINUE</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@LinuxAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FinishLinuxAgentState</span><span class="p">(</span><span class="n">LinuxAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FINISH state: Terminal state indicating task completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return same agent (no further delegation).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">agent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LinuxAgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stay in FINISH state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FinishLinuxAgentState</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtask ends in FINISH state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Round ends in FINISH state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;State name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LinuxAgentStatus</span><span class="o">.</span><span class="n">FINISH</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@LinuxAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FailLinuxAgentState</span><span class="p">(</span><span class="n">LinuxAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FAIL state: Error occurred, transition to FINISH.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return same agent.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">agent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LinuxAgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transition to FINISH after failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FinishLinuxAgentState</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Round ends after failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtask ends after failure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;State name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LinuxAgentStatus</span><span class="o">.</span><span class="n">FAIL</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@LinuxAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NoneLinuxAgentState</span><span class="p">(</span><span class="n">LinuxAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NONE state: Initial/default state, transitions to FINISH.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return same agent.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">agent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LinuxAgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transition to FINISH.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FinishLinuxAgentState</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtask ends in NONE state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Round ends in NONE state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Empty name for NONE state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>
<h3 id="creating-mobileagent-states">Creating MobileAgent States</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/states/mobile_agent_state.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.states.basic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentState</span><span class="p">,</span> <span class="n">AgentStateManager</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">MobileAgent</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MobileAgentStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Status enum for MobileAgent states.&quot;&quot;&quot;</span>
    <span class="n">FINISH</span> <span class="o">=</span> <span class="s2">&quot;FINISH&quot;</span>
    <span class="n">CONTINUE</span> <span class="o">=</span> <span class="s2">&quot;CONTINUE&quot;</span>
    <span class="n">FAIL</span> <span class="o">=</span> <span class="s2">&quot;FAIL&quot;</span>
    <span class="n">WAITING</span> <span class="o">=</span> <span class="s2">&quot;WAITING&quot;</span>  <span class="c1"># Waiting for app to load</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MobileAgentStateManager</span><span class="p">(</span><span class="n">AgentStateManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;State manager for MobileAgent.&quot;&quot;&quot;</span>

    <span class="n">_state_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">MobileAgentState</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">none_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the none state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">NoneMobileAgentState</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MobileAgentState</span><span class="p">(</span><span class="n">AgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for MobileAgent states.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the agent for the current step.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">agent_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">MobileAgent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the agent class.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">MobileAgent</span>
        <span class="k">return</span> <span class="n">MobileAgent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get next agent (same agent for device agents).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">agent</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MobileAgentState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine next state based on status.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">status</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">MobileAgentStateManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if round ends.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@MobileAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ContinueMobileAgentState</span><span class="p">(</span><span class="n">MobileAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CONTINUE state for MobileAgent.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute processor strategies.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MobileAgentStatus</span><span class="o">.</span><span class="n">CONTINUE</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@MobileAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FinishMobileAgentState</span><span class="p">(</span><span class="n">MobileAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FINISH state for MobileAgent.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MobileAgentState</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FinishMobileAgentState</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MobileAgentStatus</span><span class="o">.</span><span class="n">FINISH</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@MobileAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FailMobileAgentState</span><span class="p">(</span><span class="n">MobileAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FAIL state for MobileAgent.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MobileAgentState</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FinishMobileAgentState</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MobileAgentStatus</span><span class="o">.</span><span class="n">FAIL</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@MobileAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WaitingMobileAgentState</span><span class="p">(</span><span class="n">MobileAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WAITING state: Wait for app to load or animation to complete.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait and then transition to CONTINUE.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait 2 seconds</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">MobileAgentStatus</span><span class="o">.</span><span class="n">CONTINUE</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MobileAgentStatus</span><span class="o">.</span><span class="n">WAITING</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@MobileAgentStateManager</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NoneMobileAgentState</span><span class="p">(</span><span class="n">MobileAgentState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;NONE state for MobileAgent.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MobileAgentState</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FinishMobileAgentState</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_subtask_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_round_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>
<h3 id="state-design-guidelines">State Design Guidelines</h3>
<table>
<thead>
<tr>
<th>State</th>
<th>When to Use</th>
<th>Required Methods</th>
<th>Terminal?</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CONTINUE</strong></td>
<td>Normal execution</td>
<td><code>handle()</code> calls <code>agent.process()</code></td>
<td>No</td>
</tr>
<tr>
<td><strong>FINISH</strong></td>
<td>Task complete</td>
<td><code>is_subtask_end()</code> → <code>True</code></td>
<td>Yes</td>
</tr>
<tr>
<td><strong>FAIL</strong></td>
<td>Error occurred</td>
<td><code>next_state()</code> → <code>FINISH</code></td>
<td>Yes</td>
</tr>
<tr>
<td><strong>WAITING</strong></td>
<td>Async delays</td>
<td><code>handle()</code> with <code>await asyncio.sleep()</code></td>
<td>No</td>
</tr>
<tr>
<td><strong>NONE</strong></td>
<td>Default/initial</td>
<td><code>next_state()</code> → <code>FINISH</code></td>
<td>Yes</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">State Design Best Practices</p>
<ul>
<li>✅ Always register states with <code>@StateManager.register</code></li>
<li>✅ Implement <code>name()</code> to match status enum value</li>
<li>✅ Call <code>agent.process()</code> in <code>CONTINUE.handle()</code></li>
<li>✅ Set <code>is_round_end()</code> = <code>True</code> for terminal states</li>
<li>✅ Transition <code>FAIL</code> → <code>FINISH</code> for graceful termination</li>
<li>❌ Don't create too many states - keep it simple</li>
<li>❌ Don't call processor directly - use <code>agent.process()</code></li>
</ul>
</div>
<hr />
<h2 id="step-4-processing-strategies">Step 4: Processing Strategies</h2>
<h3 id="understanding-strategies">Understanding Strategies</h3>
<p><strong>Strategies</strong> are modular execution units that implement specific phases of the processing pipeline. Each strategy:</p>
<ul>
<li>Executes independently within its phase</li>
<li>Declares dependencies using <code>@depends_on</code> decorator</li>
<li>Provides results using <code>@provides</code> decorator</li>
<li>Returns <code>ProcessingResult</code> with success/failure status</li>
</ul>
<h3 id="linuxagent-strategies">LinuxAgent Strategies</h3>
<h4 id="strategy-1-llm-interaction">Strategy 1: LLM Interaction</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/processors/strategies/linux_agent_strategy.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.strategies.app_agent_processing_strategy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AppLLMInteractionStrategy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.context.processing_context</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProcessingContext</span><span class="p">,</span>
    <span class="n">ProcessingResult</span><span class="p">,</span>
    <span class="n">ProcessingPhase</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.core.strategy_dependency</span><span class="w"> </span><span class="kn">import</span> <span class="n">depends_on</span><span class="p">,</span> <span class="n">provides</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinuxAgent</span>


<span class="nd">@depends_on</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>  <span class="c1"># Requires &quot;request&quot; in context</span>
<span class="nd">@provides</span><span class="p">(</span>
    <span class="s2">&quot;parsed_response&quot;</span><span class="p">,</span>   <span class="c1"># Provides LLM parsed response</span>
    <span class="s2">&quot;response_text&quot;</span><span class="p">,</span>     <span class="c1"># Raw LLM response text</span>
    <span class="s2">&quot;llm_cost&quot;</span><span class="p">,</span>          <span class="c1"># LLM API cost</span>
    <span class="s2">&quot;prompt_message&quot;</span><span class="p">,</span>    <span class="c1"># Prompt sent to LLM</span>
    <span class="s2">&quot;action&quot;</span><span class="p">,</span>            <span class="c1"># Action to execute</span>
    <span class="s2">&quot;thought&quot;</span><span class="p">,</span>           <span class="c1"># LLM reasoning</span>
    <span class="s2">&quot;comment&quot;</span><span class="p">,</span>           <span class="c1"># LLM comment</span>
<span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LinuxLLMInteractionStrategy</span><span class="p">(</span><span class="n">AppLLMInteractionStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Strategy for LLM interaction with Linux Agent.</span>

<span class="sd">    Constructs prompts with Linux context, calls LLM,</span>
<span class="sd">    parses response into structured action.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fail_fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Linux LLM interaction strategy.</span>

<span class="sd">        :param fail_fast: Raise exceptions immediately on errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fail_fast</span><span class="o">=</span><span class="n">fail_fast</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ProcessingContext</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessingResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute LLM interaction for LinuxAgent.</span>

<span class="sd">        :param agent: LinuxAgent instance</span>
<span class="sd">        :param context: Processing context with request data</span>
<span class="sd">        :return: ProcessingResult with parsed LLM response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Extract request from context</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prev_plan</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

            <span class="c1"># Step 2: Build comprehensive prompt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Building Linux Agent prompt&quot;</span><span class="p">)</span>

            <span class="c1"># Get blackboard context (if multi-agent)</span>
            <span class="n">blackboard_prompt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">blackboard</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">blackboard_prompt</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">blackboard</span><span class="o">.</span><span class="n">blackboard_to_prompt</span><span class="p">()</span>

            <span class="c1"># Construct prompt message</span>
            <span class="n">prompt_message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">message_constructor</span><span class="p">(</span>
                <span class="n">dynamic_examples</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">dynamic_knowledge</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="p">,</span>
                <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                <span class="n">blackboard_prompt</span><span class="o">=</span><span class="n">blackboard_prompt</span><span class="p">,</span>
                <span class="n">last_success_actions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_last_success_actions</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Step 3: Get LLM response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting LLM response for Linux Agent&quot;</span><span class="p">)</span>
            <span class="n">response_text</span><span class="p">,</span> <span class="n">llm_cost</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_response</span><span class="p">(</span>
                <span class="n">agent</span><span class="p">,</span> <span class="n">prompt_message</span>
            <span class="p">)</span>

            <span class="c1"># Step 4: Parse and validate response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing Linux Agent response&quot;</span><span class="p">)</span>
            <span class="n">parsed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_app_response</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>

            <span class="c1"># Step 5: Extract structured data</span>
            <span class="n">structured_data</span> <span class="o">=</span> <span class="n">parsed_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">ProcessingResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;parsed_response&quot;</span><span class="p">:</span> <span class="n">parsed_response</span><span class="p">,</span>
                    <span class="s2">&quot;response_text&quot;</span><span class="p">:</span> <span class="n">response_text</span><span class="p">,</span>
                    <span class="s2">&quot;llm_cost&quot;</span><span class="p">:</span> <span class="n">llm_cost</span><span class="p">,</span>
                    <span class="s2">&quot;prompt_message&quot;</span><span class="p">:</span> <span class="n">prompt_message</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">structured_data</span><span class="p">,</span>  <span class="c1"># action, thought, comment, etc.</span>
                <span class="p">},</span>
                <span class="n">phase</span><span class="o">=</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">LLM_INTERACTION</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Linux LLM interaction failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">LLM_INTERACTION</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div>
<h4 id="strategy-2-action-execution">Strategy 2: Action Execution</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/processors/strategies/linux_agent_strategy.py</span>

<span class="nd">@depends_on</span><span class="p">(</span><span class="s2">&quot;parsed_response&quot;</span><span class="p">,</span> <span class="s2">&quot;command_dispatcher&quot;</span><span class="p">)</span>
<span class="nd">@provides</span><span class="p">(</span><span class="s2">&quot;execution_result&quot;</span><span class="p">,</span> <span class="s2">&quot;action_info&quot;</span><span class="p">,</span> <span class="s2">&quot;control_log&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LinuxActionExecutionStrategy</span><span class="p">(</span><span class="n">AppActionExecutionStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Strategy for executing actions in LinuxAgent.</span>

<span class="sd">    Dispatches shell commands to Linux MCP server,</span>
<span class="sd">    captures results, and creates action logs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fail_fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Linux action execution strategy.</span>

<span class="sd">        :param fail_fast: Raise exceptions immediately (typically False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fail_fast</span><span class="o">=</span><span class="n">fail_fast</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;LinuxAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ProcessingContext</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessingResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute Linux Agent actions.</span>

<span class="sd">        :param agent: LinuxAgent instance</span>
<span class="sd">        :param context: Processing context with parsed response</span>
<span class="sd">        :return: ProcessingResult with execution results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Extract context variables</span>
            <span class="n">parsed_response</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;parsed_response&quot;</span><span class="p">)</span>
            <span class="n">command_dispatcher</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">global_context</span><span class="o">.</span><span class="n">command_dispatcher</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed_response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ProcessingResult</span><span class="p">(</span>
                    <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No response for action execution&quot;</span><span class="p">},</span>
                    <span class="n">phase</span><span class="o">=</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Step 2: Execute the action via command dispatcher</span>
            <span class="n">execution_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_app_action</span><span class="p">(</span>
                <span class="n">command_dispatcher</span><span class="p">,</span> <span class="n">parsed_response</span><span class="o">.</span><span class="n">action</span>
            <span class="p">)</span>

            <span class="c1"># Step 3: Create action info for memory tracking</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_action_info</span><span class="p">(</span>
                <span class="n">parsed_response</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="n">execution_results</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Step 4: Print action info (for debugging)</span>
            <span class="n">action_info</span> <span class="o">=</span> <span class="n">ListActionCommandInfo</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
            <span class="n">action_info</span><span class="o">.</span><span class="n">color_print</span><span class="p">()</span>

            <span class="c1"># Step 5: Create control log</span>
            <span class="n">control_log</span> <span class="o">=</span> <span class="n">action_info</span><span class="o">.</span><span class="n">get_target_info</span><span class="p">()</span>

            <span class="n">status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">parsed_response</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">status</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed_response</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">ActionCommandInfo</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">action_info</span><span class="o">.</span><span class="n">status</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">ProcessingResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;execution_result&quot;</span><span class="p">:</span> <span class="n">execution_results</span><span class="p">,</span>
                    <span class="s2">&quot;action_info&quot;</span><span class="p">:</span> <span class="n">action_info</span><span class="p">,</span>
                    <span class="s2">&quot;control_log&quot;</span><span class="p">:</span> <span class="n">control_log</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">phase</span><span class="o">=</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Linux action execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div>
<h3 id="creating-mobileagent-strategies">Creating MobileAgent Strategies</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/agents/processors/strategies/mobile_agent_strategy.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.strategies.app_agent_processing_strategy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AppLLMInteractionStrategy</span><span class="p">,</span>
    <span class="n">AppActionExecutionStrategy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.context.processing_context</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ProcessingContext</span><span class="p">,</span>
    <span class="n">ProcessingResult</span><span class="p">,</span>
    <span class="n">ProcessingPhase</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.core.strategy_dependency</span><span class="w"> </span><span class="kn">import</span> <span class="n">depends_on</span><span class="p">,</span> <span class="n">provides</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">MobileAgent</span>


<span class="nd">@depends_on</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="s2">&quot;screenshot&quot;</span><span class="p">,</span> <span class="s2">&quot;ui_tree&quot;</span><span class="p">)</span>
<span class="nd">@provides</span><span class="p">(</span>
    <span class="s2">&quot;parsed_response&quot;</span><span class="p">,</span>
    <span class="s2">&quot;response_text&quot;</span><span class="p">,</span>
    <span class="s2">&quot;llm_cost&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prompt_message&quot;</span><span class="p">,</span>
    <span class="s2">&quot;action&quot;</span><span class="p">,</span>
    <span class="s2">&quot;thought&quot;</span><span class="p">,</span>
    <span class="s2">&quot;comment&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MobileLLMInteractionStrategy</span><span class="p">(</span><span class="n">AppLLMInteractionStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LLM interaction strategy for MobileAgent.</span>

<span class="sd">    Handles mobile UI screenshots and hierarchy for LLM understanding.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fail_fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fail_fast</span><span class="o">=</span><span class="n">fail_fast</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ProcessingContext</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessingResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute LLM interaction for mobile UI.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract mobile-specific context</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
            <span class="n">screenshot</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;screenshot&quot;</span><span class="p">)</span>
            <span class="n">ui_tree</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;ui_tree&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building Mobile Agent prompt for </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">platform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Build prompt with mobile context</span>
            <span class="n">prompt_message</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">message_constructor</span><span class="p">(</span>
                <span class="n">dynamic_examples</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">dynamic_knowledge</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_prev_plan</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
                <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                <span class="n">screenshot</span><span class="o">=</span><span class="n">screenshot</span><span class="p">,</span>
                <span class="n">ui_tree</span><span class="o">=</span><span class="n">ui_tree</span><span class="p">,</span>
                <span class="n">blackboard_prompt</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">blackboard</span><span class="o">.</span><span class="n">blackboard_to_prompt</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">blackboard</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="p">),</span>
                <span class="n">last_success_actions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_last_success_actions</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Get LLM response</span>
            <span class="n">response_text</span><span class="p">,</span> <span class="n">llm_cost</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_response</span><span class="p">(</span>
                <span class="n">agent</span><span class="p">,</span> <span class="n">prompt_message</span>
            <span class="p">)</span>

            <span class="c1"># Parse response</span>
            <span class="n">parsed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_app_response</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">response_text</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ProcessingResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;parsed_response&quot;</span><span class="p">:</span> <span class="n">parsed_response</span><span class="p">,</span>
                    <span class="s2">&quot;response_text&quot;</span><span class="p">:</span> <span class="n">response_text</span><span class="p">,</span>
                    <span class="s2">&quot;llm_cost&quot;</span><span class="p">:</span> <span class="n">llm_cost</span><span class="p">,</span>
                    <span class="s2">&quot;prompt_message&quot;</span><span class="p">:</span> <span class="n">prompt_message</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">parsed_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
                <span class="p">},</span>
                <span class="n">phase</span><span class="o">=</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">LLM_INTERACTION</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mobile LLM interaction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">LLM_INTERACTION</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@depends_on</span><span class="p">(</span><span class="s2">&quot;parsed_response&quot;</span><span class="p">,</span> <span class="s2">&quot;command_dispatcher&quot;</span><span class="p">)</span>
<span class="nd">@provides</span><span class="p">(</span><span class="s2">&quot;execution_result&quot;</span><span class="p">,</span> <span class="s2">&quot;action_info&quot;</span><span class="p">,</span> <span class="s2">&quot;control_log&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MobileActionExecutionStrategy</span><span class="p">(</span><span class="n">AppActionExecutionStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Action execution strategy for MobileAgent.</span>

<span class="sd">    Executes mobile-specific actions (tap, swipe, type, etc.)</span>
<span class="sd">    via Mobile MCP server.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fail_fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fail_fast</span><span class="o">=</span><span class="n">fail_fast</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">&quot;MobileAgent&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ProcessingContext</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessingResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute mobile actions.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed_response</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;parsed_response&quot;</span><span class="p">)</span>
            <span class="n">command_dispatcher</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">global_context</span><span class="o">.</span><span class="n">command_dispatcher</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed_response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ProcessingResult</span><span class="p">(</span>
                    <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No action to execute&quot;</span><span class="p">},</span>
                    <span class="n">phase</span><span class="o">=</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Execute mobile action</span>
            <span class="n">execution_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_app_action</span><span class="p">(</span>
                <span class="n">command_dispatcher</span><span class="p">,</span> <span class="n">parsed_response</span><span class="o">.</span><span class="n">action</span>
            <span class="p">)</span>

            <span class="c1"># Create action info</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_action_info</span><span class="p">(</span>
                <span class="n">parsed_response</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="n">execution_results</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">action_info</span> <span class="o">=</span> <span class="n">ListActionCommandInfo</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
            <span class="n">action_info</span><span class="o">.</span><span class="n">color_print</span><span class="p">()</span>

            <span class="n">control_log</span> <span class="o">=</span> <span class="n">action_info</span><span class="o">.</span><span class="n">get_target_info</span><span class="p">()</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">action_info</span><span class="o">.</span><span class="n">status</span>

            <span class="k">return</span> <span class="n">ProcessingResult</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;execution_result&quot;</span><span class="p">:</span> <span class="n">execution_results</span><span class="p">,</span>
                    <span class="s2">&quot;action_info&quot;</span><span class="p">:</span> <span class="n">action_info</span><span class="p">,</span>
                    <span class="s2">&quot;control_log&quot;</span><span class="p">:</span> <span class="n">control_log</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">phase</span><span class="o">=</span><span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mobile action execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ProcessingPhase</span><span class="o">.</span><span class="n">ACTION_EXECUTION</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1"># Middleware for mobile-specific logging</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MobileLoggingMiddleware</span><span class="p">(</span><span class="n">AppAgentLoggingMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logging middleware for MobileAgent.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">starting_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ProcessingContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return starting message.&quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Executing mobile task: [</span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2">]&quot;</span>
</code></pre></div>
<h3 id="strategy-design-checklist">Strategy Design Checklist</h3>
<ul>
<li>[ ] Use <code>@depends_on()</code> decorator to declare dependencies</li>
<li>[ ] Use <code>@provides()</code> decorator to declare outputs</li>
<li>[ ] Return <code>ProcessingResult</code> with success status</li>
<li>[ ] Handle exceptions gracefully (log, return error result)</li>
<li>[ ] Respect <code>fail_fast</code> setting</li>
<li>[ ] Use <code>self.logger</code> for debugging</li>
<li>[ ] Call <code>self.handle_error()</code> in except blocks</li>
</ul>
<hr />
<h2 id="step-5-prompter">Step 5: Prompter</h2>
<h3 id="understanding-the-prompter">Understanding the Prompter</h3>
<p>The <strong>Prompter</strong> constructs prompts for LLM interaction. It:</p>
<ul>
<li>Loads prompt templates from YAML files</li>
<li>Constructs system and user messages</li>
<li>Inserts dynamic context (request, plan, examples)</li>
<li>Formats API/tool descriptions</li>
</ul>
<h3 id="linuxagent-prompter">LinuxAgent Prompter</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/prompter/customized/linux_agent_prompter.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.prompter.agent_prompter</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppAgentPrompter</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LinuxAgentPrompter</span><span class="p">(</span><span class="n">AppAgentPrompter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prompter for LinuxAgent.</span>

<span class="sd">    Constructs prompts for shell command generation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">example_prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize LinuxAgentPrompter.</span>

<span class="sd">        :param prompt_template: Path to main prompt YAML</span>
<span class="sd">        :param example_prompt_template: Path to example prompt YAML</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">,</span> <span class="n">example_prompt_template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_prompt_template</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">system_prompt_construction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">additional_examples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct system prompt for LinuxAgent.</span>

<span class="sd">        :param additional_examples: Additional examples to include</span>
<span class="sd">        :return: System prompt string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Format API descriptions</span>
        <span class="n">apis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_prompt_helper</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Format examples</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">examples_prompt_helper</span><span class="p">(</span>
            <span class="n">additional_examples</span><span class="o">=</span><span class="n">additional_examples</span>
        <span class="p">)</span>

        <span class="c1"># Fill template</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">apis</span><span class="o">=</span><span class="n">apis</span><span class="p">,</span> <span class="n">examples</span><span class="o">=</span><span class="n">examples</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">user_prompt_construction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prev_plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">user_request</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">retrieved_docs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">last_success_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct user prompt for LinuxAgent.</span>

<span class="sd">        :param prev_plan: Previous execution plan</span>
<span class="sd">        :param user_request: User&#39;s request</span>
<span class="sd">        :param retrieved_docs: Retrieved documentation (optional)</span>
<span class="sd">        :param last_success_actions: Last successful actions</span>
<span class="sd">        :return: User prompt string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prev_plan</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prev_plan</span><span class="p">),</span>
            <span class="n">user_request</span><span class="o">=</span><span class="n">user_request</span><span class="p">,</span>
            <span class="n">retrieved_docs</span><span class="o">=</span><span class="n">retrieved_docs</span><span class="p">,</span>
            <span class="n">last_success_actions</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">last_success_actions</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">user_content_construction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prev_plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">user_request</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">retrieved_docs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">last_success_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct user content for LLM (supports multi-modal).</span>

<span class="sd">        :param prev_plan: Previous plan</span>
<span class="sd">        :param user_request: User request</span>
<span class="sd">        :param retrieved_docs: Retrieved docs</span>
<span class="sd">        :param last_success_actions: Last actions</span>
<span class="sd">        :return: List of content dicts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_content</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">user_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_prompt_construction</span><span class="p">(</span>
                <span class="n">prev_plan</span><span class="o">=</span><span class="n">prev_plan</span><span class="p">,</span>
                <span class="n">user_request</span><span class="o">=</span><span class="n">user_request</span><span class="p">,</span>
                <span class="n">retrieved_docs</span><span class="o">=</span><span class="n">retrieved_docs</span><span class="p">,</span>
                <span class="n">last_success_actions</span><span class="o">=</span><span class="n">last_success_actions</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">user_content</span>
</code></pre></div>
<h3 id="creating-mobileagent-prompter">Creating MobileAgent Prompter</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: ufo/prompter/customized/mobile_agent_prompter.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.prompter.agent_prompter</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppAgentPrompter</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MobileAgentPrompter</span><span class="p">(</span><span class="n">AppAgentPrompter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prompter for MobileAgent.</span>

<span class="sd">    Handles mobile UI screenshots and hierarchy for LLM prompts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">example_prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize MobileAgentPrompter.</span>

<span class="sd">        :param prompt_template: Path to main prompt YAML</span>
<span class="sd">        :param example_prompt_template: Path to example prompt YAML</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">,</span> <span class="n">example_prompt_template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_prompt_template</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">system_prompt_construction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">additional_examples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct system prompt for MobileAgent.&quot;&quot;&quot;</span>
        <span class="n">apis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_prompt_helper</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">examples_prompt_helper</span><span class="p">(</span>
            <span class="n">additional_examples</span><span class="o">=</span><span class="n">additional_examples</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">apis</span><span class="o">=</span><span class="n">apis</span><span class="p">,</span> <span class="n">examples</span><span class="o">=</span><span class="n">examples</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">user_prompt_construction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prev_plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">user_request</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ui_tree</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">retrieved_docs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">last_success_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct user prompt with mobile UI context.</span>

<span class="sd">        :param prev_plan: Previous plan</span>
<span class="sd">        :param user_request: User request</span>
<span class="sd">        :param ui_tree: Mobile UI hierarchy (XML/JSON)</span>
<span class="sd">        :param retrieved_docs: Retrieved docs</span>
<span class="sd">        :param last_success_actions: Last actions</span>
<span class="sd">        :return: User prompt string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_template</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prev_plan</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prev_plan</span><span class="p">),</span>
            <span class="n">user_request</span><span class="o">=</span><span class="n">user_request</span><span class="p">,</span>
            <span class="n">ui_tree</span><span class="o">=</span><span class="n">ui_tree</span><span class="p">,</span>  <span class="c1"># Mobile-specific</span>
            <span class="n">retrieved_docs</span><span class="o">=</span><span class="n">retrieved_docs</span><span class="p">,</span>
            <span class="n">last_success_actions</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">last_success_actions</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">user_content_construction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prev_plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">user_request</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">screenshot</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Mobile screenshot</span>
        <span class="n">ui_tree</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">retrieved_docs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">last_success_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct user content with screenshot for vision LLMs.</span>

<span class="sd">        :param prev_plan: Previous plan</span>
<span class="sd">        :param user_request: User request</span>
<span class="sd">        :param screenshot: Screenshot image (base64 or path)</span>
<span class="sd">        :param ui_tree: UI hierarchy</span>
<span class="sd">        :param retrieved_docs: Retrieved docs</span>
<span class="sd">        :param last_success_actions: Last actions</span>
<span class="sd">        :return: List of content dicts (text + image)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_content</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Add text prompt</span>
        <span class="n">user_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_prompt_construction</span><span class="p">(</span>
                <span class="n">prev_plan</span><span class="o">=</span><span class="n">prev_plan</span><span class="p">,</span>
                <span class="n">user_request</span><span class="o">=</span><span class="n">user_request</span><span class="p">,</span>
                <span class="n">ui_tree</span><span class="o">=</span><span class="n">ui_tree</span><span class="p">,</span>
                <span class="n">retrieved_docs</span><span class="o">=</span><span class="n">retrieved_docs</span><span class="p">,</span>
                <span class="n">last_success_actions</span><span class="o">=</span><span class="n">last_success_actions</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">})</span>

        <span class="c1"># Add screenshot if available (for vision LLMs)</span>
        <span class="k">if</span> <span class="n">screenshot</span><span class="p">:</span>
            <span class="n">user_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image_url&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image_url&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data:image/png;base64,</span><span class="si">{</span><span class="n">screenshot</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">},</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">user_content</span>
</code></pre></div>
<h3 id="prompter-best-practices">Prompter Best Practices</h3>
<ul>
<li>✅ Inherit from <code>AppAgentPrompter</code> for standard structure</li>
<li>✅ Use <code>self.prompt_template</code> and <code>self.example_prompt_template</code></li>
<li>✅ Implement <code>system_prompt_construction()</code> and <code>user_prompt_construction()</code></li>
<li>✅ Use <code>user_content_construction()</code> for multi-modal content</li>
<li>✅ Format examples with <code>examples_prompt_helper()</code></li>
<li>✅ Format APIs with <code>api_prompt_helper()</code></li>
<li>❌ Don't hardcode prompts - use YAML templates</li>
</ul>
<hr />
<h2 id="testing-your-implementation">Testing Your Implementation</h2>
<h3 id="unit-test-agent-class">Unit Test: Agent Class</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: tests/unit/test_mobile_agent.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">MobileAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.processors.customized.customized_agent_processor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MobileAgentProcessor</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestMobileAgent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unit tests for MobileAgent.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">agent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create test MobileAgent instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MobileAgent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_mobile_agent&quot;</span><span class="p">,</span>
            <span class="n">main_prompt</span><span class="o">=</span><span class="s2">&quot;ufo/prompts/third_party/mobile_agent.yaml&quot;</span><span class="p">,</span>
            <span class="n">example_prompt</span><span class="o">=</span><span class="s2">&quot;ufo/prompts/third_party/mobile_agent_example.yaml&quot;</span><span class="p">,</span>
            <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;android&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_agent_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test agent initializes correctly.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">agent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;test_mobile_agent&quot;</span>
        <span class="k">assert</span> <span class="n">agent</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;android&quot;</span>
        <span class="k">assert</span> <span class="n">agent</span><span class="o">.</span><span class="n">prompter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">agent</span><span class="o">.</span><span class="n">blackboard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_processor_registration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test processor is registered correctly.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s2">&quot;_processor_cls&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">agent</span><span class="o">.</span><span class="n">_processor_cls</span> <span class="o">==</span> <span class="n">MobileAgentProcessor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test default state is set.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.states.mobile_agent_state</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContinueMobileAgentState</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">default_state</span><span class="p">,</span> <span class="n">ContinueMobileAgentState</span><span class="p">)</span>
</code></pre></div>
<h3 id="integration-test-full-pipeline">Integration Test: Full Pipeline</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># File: tests/integration/test_mobile_agent_pipeline.py</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.agents.agent.customized_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">MobileAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufo.module.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">Context</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestMobileAgentPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration tests for MobileAgent pipeline.&quot;&quot;&quot;</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agent_with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create agent with context.&quot;&quot;&quot;</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">MobileAgent</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_agent&quot;</span><span class="p">,</span>
            <span class="n">main_prompt</span><span class="o">=</span><span class="s2">&quot;ufo/prompts/third_party/mobile_agent.yaml&quot;</span><span class="p">,</span>
            <span class="n">example_prompt</span><span class="o">=</span><span class="s2">&quot;ufo/prompts/third_party/mobile_agent_example.yaml&quot;</span><span class="p">,</span>
            <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;android&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="s2">&quot;Tap the login button&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">agent</span><span class="p">,</span> <span class="n">context</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_processor_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_with_context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test processor executes all strategies.&quot;&quot;&quot;</span>
        <span class="n">agent</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">agent_with_context</span>

        <span class="c1"># Execute processor</span>
        <span class="n">processor</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">_processor_cls</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

        <span class="c1"># Verify strategies executed</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="s2">&quot;parsed_response&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">get_all_local</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="summary">Summary</h2>
<p><strong>What You've Built</strong>:</p>
<ul>
<li><strong>Agent Class</strong> - MobileAgent with registration and initialization</li>
<li><strong>Processor</strong> - MobileAgentProcessor with strategy orchestration</li>
<li><strong>State Manager</strong> - MobileAgentStateManager with FSM states</li>
<li><strong>Strategies</strong> - LLM and action execution strategies</li>
<li><strong>Prompter</strong> - MobileAgentPrompter for prompt construction</li>
</ul>
<p><strong>Next Step</strong>: <a href="../mcp_server/">Part 2: MCP Server Development →</a></p>
<hr />
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><strong><a href="../../../infrastructure/agents/overview/">Agent Architecture</a></strong> - Three-layer architecture</li>
<li><strong><a href="../../../infrastructure/agents/design/processor/">Processor Design</a></strong> - Processor deep dive</li>
<li><strong><a href="../../../infrastructure/agents/design/strategy/">Strategy Pattern</a></strong> - Strategy implementation</li>
<li><strong><a href="../../../infrastructure/agents/design/state/">State Machine</a></strong> - State management</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../client_setup/" class="btn btn-neutral float-left" title="Client Setup"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../mcp_server/" class="btn btn-neutral float-right" title="MCP Server">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../client_setup/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../mcp_server/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      <script src="../../../javascripts/mermaid-init.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
